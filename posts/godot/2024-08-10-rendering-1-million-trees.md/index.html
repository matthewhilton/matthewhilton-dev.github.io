<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="This is my plan to render millions of trees for a ski resort game i&rsquo;m building. You&rsquo;ll probably want to have a bit of knowledge of game internal/engines for this one.
How it all started
Recently i&rsquo;ve been pottering around in Godot for a while. The story of how I got into using Godot is best left for another day.
As an avid mountain biker, I thought it would be a great idea to make a game about building MTB trails. Easy, right ? Just build a path, add some jumps and add some AIs&mldr;"><title>My plan to render 1 million trees
</title><link rel="shortcut icon" type=image/x-icon href=/><link rel=stylesheet href=/css/main.51652302d3a998bf7887aed5c2cf89141bbebdf45a2c8f87b0717a3cf4f51c4e53c694c328fb1de78c3a625a1c01f80745bf1f2f42c040647a245cbbb6c2d1d7.css integrity="sha512-UWUjAtOpmL94h67Vws+JFBu+vfRaLI+HsHF6PPT1HE5TxpTDKPsd54w6YlocAfgHRb8fL0LAQGR6JFy7tsLR1w=="><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@200..900&display=swap" rel=stylesheet><style>body{font-family:noto serif jp,serif;font-optical-sizing:auto}</style></head><body a=auto><main class=page-content aria-label=Content><div class=w><div class=post-meta><a href=/>..</a><p><time datetime="2024-08-10 00:00:00 +0000 UTC">2024-08-10</time></p></div><article><h1>My plan to render 1 million trees</h1><aside><nav id=TableOfContents><ul><li><a href=#how-it-all-started>How it all started</a></li><li><a href=#prior-art>Prior art</a><ul><li><a href=#ski-resort-tycoon-2000>Ski resort tycoon (2000)</a></li><li><a href=#snowtopia-2022>Snowtopia (2022)</a></li></ul></li><li><a href=#a-tangent-about-ski-maps>A tangent about ski maps</a></li><li><a href=#starting-small>Starting small</a></li><li><a href=#ok-now-i-render-the-trees>Ok, now I render the trees</a><ul><li><a href=#the-first-attempt>The first attempt</a></li><li><a href=#why-fake-3d-when-you-can-use-3d>Why fake 3D when you can use 3D</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></aside><p>This is my plan to render millions of trees for a ski resort game i&rsquo;m building. You&rsquo;ll probably want to have a bit of knowledge of game internal/engines for this one.</p><h2 id=how-it-all-started>How it all started</h2><p>Recently i&rsquo;ve been pottering around in <a href=https://godotengine.org/>Godot</a> for a while. The story of how I got into using Godot is best left for another day.</p><p>As an avid mountain biker, I thought it would be a great idea to make a game about building MTB trails. Easy, right ? Just build a path, add some jumps and add some AIs&mldr;</p><p>Well turns out building a complex system of in-game editable 3D <a href=https://en.wikipedia.org/wiki/B%C3%A9zier_curve>BÃ©zier curves</a> with controls (essentially, rudimentry CAD software inside of a game engine) is not as easy as it, uh, initially seemed&mldr; And while I would regard my skills in linear algebra to be &lsquo;adequate&rsquo;, the feature creep really started to put me off the project. I really needed to practice <a href=https://en.wikipedia.org/wiki/KISS_principle>KISS</a>.</p><p>After putting that project on indefinite hold, my mind began to wander at what I could work on next.</p><p>If you are not aware, it&rsquo;s currently ski season in the southern hemisphere. Being an keen snowboarder who cries a little on the inside at the price of going skiing, my mind began to wonder if I could build a game about building a snow resort.</p><h2 id=prior-art>Prior art</h2><p>Before I start any project, I always do what I call a &lsquo;wishful Google&rsquo;. This is where you Google something that you don&rsquo;t think exists, but it <em>could</em>, so you Google it anyway (This is how I found many interesting things, like <a href=https://www.skimachine.com/>indoor ski/snowboard simulators</a>).</p><p>A bit of wishful Googling later came up with a few snow resort building games:</p><h3 id=ski-resort-tycoon-2000>Ski resort tycoon (2000)</h3><p><a href=https://www.myabandonware.com/game/ski-resort-tycoon-beo>https://www.myabandonware.com/game/ski-resort-tycoon-beo</a></p><p>This game has that awesome 2000&rsquo;s isometric pixel art aesthetic, like the original <a href=https://en.wikipedia.org/wiki/RollerCoaster_Tycoon>Rollercoaster Tycoon</a>, or <a href=https://en.wikipedia.org/wiki/SimCity_2000>Sim City 2000</a>. It even has the typical quirky in-game mechanics akin to Sim city 2000&rsquo;s robotic alien, according to it&rsquo;s <a href=https://en.wikipedia.org/wiki/Ski_Resort_Tycoon>Wikipedia page</a>:</p><blockquote><p>A Yeti can also be seen in the game, and it can be found eating the guests.</p></blockquote><p><img src=ski-resort-tycoon.jpg alt="Ski resort tycoon game screenshot"></p><h3 id=snowtopia-2022>Snowtopia (2022)</h3><p><a href=https://store.steampowered.com/app/1124260/Snowtopia_Ski_Resort_Builder/>https://store.steampowered.com/app/1124260/Snowtopia_Ski_Resort_Builder/</a></p><p>This seems on the surface like a modern full 3D GPU accelerated version of Ski resort tycoon - a spiritual successor if you will. While I would like to try it, the reviews don&rsquo;t seem promising. Furthermore, the developers have abandonded it :(</p><p><img src=snowtopia.jpg alt="Snowtopia game screenshot"></p><h2 id=a-tangent-about-ski-maps>A tangent about ski maps</h2><p>Did you know there are only a few people in the world who make ski maps? I found this out after stumbling across <a href="https://www.youtube.com/watch?v=Umy6lyjDDdg">this video</a> about an artist Jim Niehues who has painted a LOT of ski maps.</p><p>Ski maps have something beautiful about them, almost like a <a href=https://en.wikipedia.org/wiki/Where%27s_Wally%3F>Where&rsquo;s Wally</a> or <a href=https://en.wikipedia.org/wiki/I_Spy_(book_series)>I-Spy</a> book. Being able to zoom in and see every fine detail: each individual tree, the shadows casted by the ridgelines, the tiny town below, is awe-inspiring - I could stare at them for hours.</p><p>I had a thought - what if I could turn this into a game? Make it interactive? That would be <em>awesome</em>.</p><p><img src=skimap.jpg alt="Ski map"></p><h2 id=starting-small>Starting small</h2><p>After coming to the conclusion that these games really didn&rsquo;t cut it. I decided to go all-in and start making my own. But first I had to set some central tenets to stick to:</p><ol><li>High Level of details (LOD) and a big map. I want to zoom in to see the individual trees, and zoom out to see the big picture.</li><li>Animated. Like a ski map came to life.</li><li>Well optimised. I&rsquo;m not talking about mobile phones here, but just your mid-level gaming setup.</li></ol><p>This means (at least for now):</p><ol><li>No management. No money. It&rsquo;s not a tycoon game.</li><li>Basic AI. We really <em>don&rsquo;t</em> need to simulate how hungry they are&mldr;</li><li>Simple art style. <a href=https://www.reddit.com/r/CitiesSkylines/comments/17gfq13/the_game_does_render_individual_teeth_with_no_lod/>No need to render individual teeth</a>.</li></ol><h2 id=ok-now-i-render-the-trees>Ok, now I render the trees</h2><h3 id=the-first-attempt>The first attempt</h3><p>This was a 2d scene setup as follows, after a bit of playing around:</p><ul><li><code>MultiMesh2D</code> to render the meshes i.e. lots of tree sprites. ~500k trees..</li><li><code>SubViewport</code> containing the multimesh, which would periodically be toggled on then off again, so the multimesh was only rendered when necessary (e.g. building a lift and clearing the trees).</li><li><code>Sprite2D</code> showing the output of the Subviewport.</li></ul><p><img src=2d.png alt="2D trees generation"></p><p>However this had one huge drawback - y sort hell. Y sorting is basically a fake &lsquo;3d&rsquo; in a 2d game. Through some mechanism (i&rsquo;m not actually sure if its done in the CPU or GPU) Godot will layer the 2d sprites based off their Y height.</p><p>With this setup, we basically cannot use Y sorting. For starters, <code>MultiMesh2D</code> as far I know does not have per-instance Y sort. Also, we bake it into an image for performance so it actually ends up just being one node.</p><p>I tried to get around this using shaders to manually do the y sort, for example here the black line is actually in front of the image, but has a shader that is detecting a tree lower than it and does not display anything.</p><p><img src=fake-y-sort.png alt="Fake y sort with trees"></p><p>While possible, I can see this becoming really messy if every single object needs to have this shader on it. This is even <em>without</em> implementing shadows, which is a whole another mess in 2D.</p><p>It&rsquo;s clear we need a rethink.</p><h3 id=why-fake-3d-when-you-can-use-3d>Why fake 3D when you can use 3D</h3><p>I realised I was trying to fake 3D. Why not just bite the bullet and use 3D? Then we can place objects in actual 3d space and have the correct occlusion and shadows. The downside is that we can&rsquo;t render all the trees at once in 3D and have it be performant (especially with shadows), like I did with the 2D MultiMesh2D + Subviewport.</p><p>The plan: render small chunks, and cache them as images.</p><p>(For reference this is essentially the <a href=https://80.lv/articles/inside-game-development-using-impostors>imposters technique</a>)</p><p>Instead of using <code>MultiMesh3D</code> which is bottlenecked by the CPU (for setting the transforms as we move it around and render the small chunks), we&rsquo;ll need to use <code>GPUParticles3D</code> to render the trees.</p><p>The word particles makes it seem like we are making some effects like smoke or explosions, but really particle systems are just a collection of transforms (think position + rotation) + extra data (color, etc&mldr;) that are updated by a shader (shader = gpu code) which control how a collection of (importantly) the same meshes are rendered. They are about the most efficient way you can render lots of meshes that move around. <a href=https://docs.godotengine.org/en/stable/tutorials/3d/particles/index.html>You can read more about them here</a>.</p><p>We can move this particle node around an have it spawn a subset of the trees, and capture these as images. This is possible because trees are pretty static and don&rsquo;t move all that much. The trees are just quad meshes (i.e. a flat plane) with a tree texture, and a normalmap so they can generate shadows across the texture.</p><p><img src=render-small-chunks.png alt="Rendering small chunks at a time"></p><p>I was able to generate a 1024x1024 (1,048,576 !) grid of trees in small chunks of 64x64 and still have a decent 500+ fps <em>with</em> shadows.</p><p>This shows the quads displaying the baked images of each chunk, and the actual world behind it (the red line is the ski lift tree mask, which is making the tree particles there invisible):
<img src=baked-quads.png alt="Baked quads"></p><p>Here it is zoomed out, viewing all 1 million trees (the bottom corner is a ski line, if you were wondering):
<img src=one-million-trees.png alt="One million trees"></p><p>And zoomed in (with a random mesh for testing the 3d occlusion):
<img src=trees-with-shadows.png alt="Trees with shadows"></p><p>I even designed a rudimentry (static) ski lift:
<img src=ski-lift-line.png alt="Ski lift line"></p><p>To have animation we can play a trick on the viewer and have the visible chunks update while they are zoomed in (which is quite fast because there are only a few of them visible at a time), but then update at a much slower rate when zoomed out (which doesn&rsquo;t matter as much because you can&rsquo;t see much detail zoomed out).</p><h2 id=conclusion>Conclusion</h2><p>While i&rsquo;m not sure the final game would have 1 million trees in an actual map (it kinda just turns into white noise if you zoom out), it&rsquo;s nice to know if the game performs well now under this stress test that it (hopefully) would perform even better when scaled back.</p><p>I am quite pleased at how the shadows really just make everything look so much nicer. I love the pixel style, and interestingly the need to update each chunk individually adds some slight stuttering which really makes it feel like a 2000s game.</p><p>I think next, I&rsquo;m going to try add some life to the game by adding the AI skiers and snowboarders.</p></article></div></main></body></html>